Raphael.fn.g.piechart=function(t,e,l,r,s){function a(t,e,l,r,s,a){var i=Math.PI/180,o=t+l*Math.cos(-r*i),h=t+l*Math.cos(-s*i),n=t+l/2*Math.cos(-(r+(s-r)/2)*i),c=e+l*Math.sin(-r*i),u=e+l*Math.sin(-s*i),f=e+l/2*Math.sin(-(r+(s-r)/2)*i),d=["M",t,e,"L",o,c,"A",l,l,0,+(Math.abs(s-r)>180),1,h,u,"z"];return d.middle={x:n,y:f},d}s=s||{};var i,o=this,h=[],n=this.set(),c=this.set(),u=this.set(),f=r.length,d=0,v=0,g=0,m=0,p=9,b=!1;if(c.covers=n,1==f)u.push(this.circle(t,e,l).attr({fill:s.colors&&s.colors[0]||this.g.colors[0]||"#666",stroke:s.stroke||"#fff","stroke-width":null==s.strokewidth?1:s.strokewidth})),n.push(this.circle(t,e,l).attr(this.g.shim)),v=r[0],r[0]={value:r[0],order:0,valueOf:function(){return this.value}},u[0].middle={x:t,y:e},u[0].mangle=180;else{for(var k=0;f>k;k++)r[k]>0&&(g+=1,i=k),v+=r[k],r[k]={value:r[k],order:k,valueOf:function(){return this.value}};for(1==g&&r[i]==v&&(u.push(this.circle(t,e,l).attr({fill:s.colors[i]||"#666",stroke:s.stroke||"#fff","stroke-width":null==s.strokewidth?1:s.strokewidth})),n.push(this.circle(t,e,l).attr(this.g.shim)),v=r[0],r[0]={value:r[0],order:0,valueOf:function(){return this.value}},u[0].middle={x:t,y:e},u[0].mangle=180),k=0;f>k;k++)b&&360*r[k]/v<=1.5&&(p=k,b=!1),k>p&&(b=!1,r[p].value+=r[k],r[p].others=!0,m=r[p].value);for(f=Math.min(p+1,r.length),m&&r.splice(f)&&(r[p].others=!0),k=0;f>k;k++){var x=d-360*r[k]/v/2;if(k||(d=360*r[k]/v/2+(360*r[k]/v/2-270),x=d-360*r[k]/v/2),s.init)var w=a(t,e,1,d,d-360*r[k]/v).join(",");var y=a(t,e,l,d,d-=360*r[k]/v),M=this.path(s.init?w:y).attr({fill:s.colors&&s.colors[k]||this.g.colors[k]||"#666",stroke:s.stroke||"#fff","stroke-width":null==s.strokewidth?1:s.strokewidth,"stroke-linejoin":"round"});M.value=r[k],M.middle=y.middle,M.mangle=x,h.push(M),u.push(M),s.init&&M.animate({path:y.join(",")},+s.init-1||1e3,">")}for(k=0;f>k;k++)M=o.path(h[k].attr("path")).attr(this.g.shim),s.href&&s.href[k]&&M.attr({href:s.href[k]}),M.attr=function(){},n.push(M),u.push(M)}c.hover=function(s,a){a=a||function(){};for(var i=this,o=0;f>o;o++)!function(o,h,n){var c={sector:o,cover:h,cx:t,cy:e,mx:o.middle.x,my:o.middle.y,mangle:o.mangle,r:l,value:r[n],total:v,label:i.labels&&i.labels[n]};h.mouseover(function(){s.call(c)}).mouseout(function(){a.call(c)})}(u[o],n[o],o);return this},c.each=function(s){for(var a=this,i=0;f>i;i++)!function(i,o,h){var n={sector:i,cover:o,cx:t,cy:e,x:i.middle.x,y:i.middle.y,mangle:i.mangle,r:l,value:r[h],total:v,label:a.labels&&a.labels[h]};s.call(n)}(u[i],n[i],i);return this},c.click=function(s){for(var a=this,i=0;f>i;i++)!function(i,o,h){var n={sector:i,cover:o,cx:t,cy:e,mx:i.middle.x,my:i.middle.y,mangle:i.mangle,r:l,value:r[h],total:v,label:a.labels&&a.labels[h]};o.click(function(){s.call(n)})}(u[i],n[i],i);return this},c.inject=function(t){t.insertBefore(n[0])};var B=function(a,i,h,d){var g=t+l+l/5,m=e,p=m+10;a=a||[],d=d&&d.toLowerCase&&d.toLowerCase()||"east",h=o.g.markers[h&&h.toLowerCase()]||"disc",c.labels=o.set();for(var b=0;f>b;b++){var k,x=u[b].attr("fill"),w=r[b].order;r[b].others&&(a[w]=i||"Others"),a[w]=o.g.labelise(a[w],r[b],v),c.labels.push(o.set()),c.labels[b].push(o.g[h](g+5,p,5).attr({fill:x,stroke:"none"})),c.labels[b].push(k=o.text(g+20,p,a[w]||r[w]).attr(o.g.txtattr).attr({fill:s.legendcolor||"#000","text-anchor":"start"})),n[b].label=c.labels[b],p+=1.2*k.getBBox().height}var y=c.labels.getBBox(),M={east:[0,-y.height/2],west:[-y.width-2*l-20,-y.height/2],north:[-l-y.width/2,-l-y.height-10],south:[-l-y.width/2,l+10]}[d];c.labels.translate.apply(c.labels,M),c.push(c.labels)};return s.legend&&B(s.legend,s.legendothers,s.legendmark,s.legendpos),c.push(u,n),c.series=u,c.covers=n,c};
